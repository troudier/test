
variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  hasDeploy: $[or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/develop') )]


trigger:
  branches:
    include:
    - master
    - develop
    - releases/*
    - feature/*
    
pool:
  vmImage: ubuntu-latest
    
    
stages:
- stage: Prepare
  jobs:
  - job: Composer 
    steps:
      - script: composer install
        displayName: install composer dependencies
  
- stage: A
  dependsOn: Prepare
  jobs:
  - job: A1
    steps:

    - script: echo Hello, world!
      displayName: 'Run a one-line script'

    - script: |
        echo Add other tasks to build, test, and deploy your project.
        echo See https://aka.ms/yaml
      displayName: 'Run a multi-line script'
      
  - job: A2
    dependsOn: A1

- stage: B
  dependsOn: Prepare
  jobs:
  - job: B1
  - job: B2

- stage: deployment
  dependsOn: [A, B]
  condition: eq(variables.hasDeploy, true)
  jobs:
  - deployment: deployProd     
    condition: eq(variables.isMain, true)
    pool:
      vmImage: ubuntu-latest
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo Hi!
          
  - deployment: deployProd     
    condition: eq(variables.isMain, false)
    pool:
      vmImage: ubuntu-latest
    environment: test
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo Hi!
  - job: notify
    steps:
    - script: echo notify
      displayName: send notification
          
          
